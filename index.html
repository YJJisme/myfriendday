<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‚Šç·£äººé‘‘å®šä¸­å¿ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* CSS Reset & Basic Style */
        :root {
            --bg-color: #000000;
            --text-color: #FFFFFF;
            --font-family: 'Courier Prime', 'Courier New', Courier, monospace, 'Microsoft JhengHei', sans-serif;
            --accent-color: #FFFFFF;
        }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family);
            overflow-x: hidden; /* Prevent horizontal scroll */
            overflow-y: auto;   /* Allow vertical scroll */
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Starfield Background */
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
        }

        @keyframes twinkle {
            0% { opacity: 0; transform: scale(0.5); }
            50% { opacity: var(--opacity); transform: scale(1); }
            100% { opacity: 0; transform: scale(0.5); }
        }

        /* Shooting Star */
        .shooting-star {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.1), 0 0 0 8px rgba(255, 255, 255, 0.1), 0 0 20px rgba(255, 255, 255, 1);
            animation: shoot 3s linear infinite;
            opacity: 0;
        }

        .shooting-star::before {
            content: '';
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            height: 1px;
            background: linear-gradient(90deg, #fff, transparent);
        }

        @keyframes shoot {
            0% {
                transform: rotate(315deg) translateX(0);
                opacity: 1;
            }
            70% {
                opacity: 1;
            }
            100% {
                transform: rotate(315deg) translateX(-1000px);
                opacity: 0;
            }
        }

        /* Layout Utilities */
        .center-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100%;
            min-height: 100vh; /* Changed from fixed height to min-height */
            text-align: center;
            padding: 40px 20px; /* Added more padding */
            box-sizing: border-box;
            position: relative; /* Changed from absolute to relative */
        }

        /* Ensure full screen absolute positioning for specific overlays if needed */
        .overlay-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 1.5s ease-in-out forwards;
            opacity: 0;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-out {
            animation: fadeOut 1.5s ease-in-out forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* Portrait Warning */
        #portrait-warning {
            z-index: 9999;
            background-color: #000;
            display: none;
        }

        @media screen and (orientation: portrait) {
            #portrait-warning {
                display: flex;
            }
            #main-content {
                display: none;
            }
        }

        /* Quiz Styles */
        .quiz-container {
            width: 100%;
            max-width: 600px;
            text-align: left;
        }

        .question-block {
            margin-bottom: 30px;
        }

        .question-title {
            font-size: 1.1rem;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .options label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .options label:hover {
            opacity: 1;
        }

        input[type="radio"] {
            margin-right: 10px;
            accent-color: #FFF;
        }

        /* Progress Bar */
        .progress-container {
            width: 80%;
            max-width: 400px;
            height: 2px;
            background: #333;
            margin: 20px 0;
            position: relative;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: #FFF;
            transition: width 0.1s linear;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .pulse-bar {
            animation: glow 2s ease-in-out infinite;
        }
        @keyframes glow {
            0% { box-shadow: 0 0 6px rgba(255,255,255,0.4); }
            50% { box-shadow: 0 0 16px rgba(255,255,255,0.9); }
            100% { box-shadow: 0 0 6px rgba(255,255,255,0.4); }
        }

        /* Buttons */
        button {
            background: transparent;
            border: 1px solid #FFF;
            color: #FFF;
            padding: 12px 24px;
            margin-top: 20px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #FFF;
            color: #000;
        }

        /* Envelope */
        #envelope-svg {
            width: 100px;
            height: 60px;
            cursor: pointer;
            stroke: #FFF;
            stroke-width: 2;
            fill: none;
            transition: transform 0.3s;
        }
        
        #envelope-svg:hover {
            transform: scale(1.1);
        }

        /* Message Area */
        #message-area {
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 1.2rem;
            max-width: 80%;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
        }
        .page-title {
            font-size: 1.6rem;
            font-weight: bold;
            margin-bottom: 16px;
        }
        #result-metrics {
            font-size: 0.95rem;
            color: #ccc;
            margin-top: 8px;
        }
        .fine-print {
            font-size: 0.8rem;
            color: #888;
            margin-top: 10px;
        }

        /* Extras */
        #extras-container {
            margin-top: 40px;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .link-text {
            text-decoration: underline;
            cursor: pointer;
            margin-top: 20px;
            font-size: 0.9rem;
            color: #CCC;
            transition: color 0.3s;
        }

        .link-text:hover {
            color: #FFF;
        }

        #capture-area {
            padding: 20px;
            background: #000; /* Ensure bg is captured */
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        
        /* Reveal Background */
        #reveal-phase.has-bg {
            background-size: cover;
            background-position: center;
        }
        #reveal-phase.has-bg::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.45);
            z-index: 0;
        }
        #reveal-phase.has-bg > * {
            position: relative;
            z-index: 1;
        }
        
        /* Log Phase */
        #log-phase {
            background: #000;
            color: #00ff9c;
        }
        .log-container {
            width: 90%;
            max-width: 800px;
            height: 240px;
            border: 1px solid #00ff9c;
            padding: 16px;
            box-sizing: border-box;
            overflow: hidden;
            font-family: 'Courier Prime', monospace;
            font-size: 0.9rem;
        }
        #log-area {
            margin: 0;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        /* Metrics */
        #analysis-metrics {
            font-size: 0.95rem;
            color: #ccc;
        }
        
        /* Footer */
        #app-footer {
            position: fixed;
            bottom: 6px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 0.75rem;
            color: #888;
            pointer-events: none;
        }

    </style>
</head>
<body>

    <!-- Portrait Warning -->
    <div id="portrait-warning" class="center-screen">
        <p>è«‹æ—‹è½‰æ‰‹æ©Ÿä»¥å•Ÿç”¨åˆ†æ</p>
    </div>
    
    <!-- Background Stars Container -->
    <div id="stars-container" style="position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:-1;"></div>

    <!-- Main Content -->
    <div id="main-content" class="center-screen">
        
        <!-- Phase 1: Quiz -->
        <div id="quiz-phase" class="center-screen hidden">
            <div class="quiz-container fade-in">
                <div class="page-title">é‚Šç·£äººé‘‘å®šä¸­å¿ƒ</div>
                <div id="subject-id" class="fine-print"></div>
                <div class="fine-print">è³‡æ–™åƒ…ç”¨æ–¼æ¼”ç®—æ³•æ¨¡æ“¬</div>
                <div class="question-block">
                    <div class="question-title">Q1ï¼šé—œæ–¼è·¨å¹´ï¼Œä½ çš„é€šå¸¸ç‹€æ…‹æ˜¯ï¼Ÿ</div>
                    <div class="options">
                        <label><input type="radio" name="q1" value="A"> (A) è·Ÿä¸€å¤§ç¾¤æœ‹å‹å»äººæ“ äººçœ‹ç…™ç«ã€‚</label>
                        <label><input type="radio" name="q1" value="B"> (B) è·Ÿå¹¾å€‹è€æœ‹å‹èšé¤ã€‚</label>
                        <label><input type="radio" name="q1" value="C"> (C) æ²’ç‰¹åˆ¥æ„Ÿè¦ºï¼Œé€šå¸¸åœ¨ç¡è¦ºä¸­åº¦éã€‚</label>
                    </div>
                </div>
                <div class="question-block">
                    <div class="question-title">Q2ï¼šç¤¾äº¤è»Ÿé«”ä¸­çš„çœŸå¿ƒå¥½å‹æ•¸æ˜¯å¦è¶…é 10 å€‹ï¼Ÿ</div>
                    <div class="options">
                        <label><input type="radio" name="q2" value="A"> (A) è¶…éï¼Œäº’å‹•å¾ˆé »ç¹ã€‚</label>
                        <label><input type="radio" name="q2" value="B"> (B) å·®ä¸å¤š 10 å€‹å·¦å³ã€‚</label>
                        <label><input type="radio" name="q2" value="C"> (C) 10 å€‹ï¼Ÿé‚£æ˜¯å¤©æ–‡æ•¸å­—å§ã€‚</label>
                    </div>
                </div>
                <div class="question-block">
                    <div class="question-title">Q3ï¼šä¸Šæ¬¡èˆ‡æœ‹å‹ä¸»å‹•èŠå¤©ï¼ˆéå…¬äº‹ï¼‰æ˜¯å¦å·²è¶…é 24 å°æ™‚ï¼Ÿ</div>
                    <div class="options">
                        <label><input type="radio" name="q3" value="A"> (A) å‰›èŠå®Œï¼Œè¨Šæ¯æ²’æ–·éã€‚</label>
                        <label><input type="radio" name="q3" value="B"> (B) 24 å°æ™‚å…§æœ‰éç°¡çŸ­äº¤è«‡ã€‚</label>
                        <label><input type="radio" name="q3" value="C"> (C) çµ•å°è¶…é 24 å°æ™‚äº†ã€‚</label>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button id="btn-submit-quiz">æäº¤åˆ†æ</button>
                </div>
            </div>
        </div>

        <!-- Phase 2: Analysis / Waiting -->
        <div id="analysis-phase" class="center-screen hidden">
            <div class="fade-in" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                <p id="analysis-status">> ç‹€æ…‹ï¼šæ­£åœ¨é€²è¡Œæœ€å¾Œæ•¸æ“šå°è£èˆ‡åŠ å¯†...</p>
                <div class="progress-container">
                    <div id="progress-bar" class="progress-bar"></div>
                </div>
                <p id="analysis-countdown" class="pulse">> é è¨ˆåˆ†æå®Œæˆå‰©é¤˜æ™‚é–“ï¼šè¨ˆç®—ä¸­...</p>
                <p id="analysis-metrics" class="pulse">> ç’°å¢ƒç†µå€¼ï¼šåˆå§‹åŒ–ä¸­...</p>
                <button id="btn-calendar" class="hidden">ğŸ”” å°‡è§£é–æ™‚é–“åŠ å…¥æ—¥æ›†</button>
            </div>
        </div>

        <!-- Hacker Log Phase -->
        <div id="log-phase" class="center-screen hidden">
            <div class="log-container">
                <pre id="log-area"></pre>
            </div>
        </div>

        <!-- Phase 3: Result (The Reveal part 1) -->
        <div id="result-phase" class="center-screen hidden">
            <div class="fade-in">
                <div class="result-title">é‘‘å®šçµæœï¼šæ‚¨çš„é‚Šç·£äººæŒ‡æ•¸ç‚º 0%</div>
                <div id="result-metrics"></div>
                <button id="btn-reveal-details">æŸ¥çœ‹è©³ç´°åˆ†æå ±å‘Š</button>
            </div>
        </div>

        <!-- Phase 4: Envelope & Message (The Reveal part 2) -->
        <div id="reveal-phase" class="center-screen hidden">
            <div id="envelope-container" class="center-screen fade-in">
                <svg id="envelope-svg" viewBox="0 0 100 60">
                    <rect x="2" y="2" width="96" height="56" rx="2" />
                    <polyline points="2,2 50,35 98,2" />
                </svg>
            </div>
            <div id="message-container" class="hidden center-screen">
                <div id="capture-area">
                    <div id="message-area" style="white-space: pre-wrap; font-size: 1.2rem; line-height: 1.6;"></div>
                    <div id="extras-container" class="hidden" style="margin-top: 30px;">
                        <div id="trivia-text" class="link-text">ğŸ’¡ å†·çŸ¥è­˜ï¼šç•¶äººè¢«å‚¬ä¿ƒæ™‚ï¼Œä¹Ÿèƒ½æœ‰å¥½å¿ƒæƒ…ï¼Ÿ(é»æ“Šäº†è§£)</div>
                        <button id="btn-save" style="margin-top: 20px;" data-html2canvas-ignore>ğŸ“¥ æ”¶è—é€™ä»½ç¥ç¦</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
    
    <div id="app-footer">v1.0.3 Â· Temporal Computing Group Â© 2026</div>

    <script>
        // Security
        document.addEventListener('contextmenu', event => event.preventDefault());
        document.addEventListener('keydown', event => {
            if (event.ctrlKey && (event.key === 's' || event.key === 'S' || event.key === 'u' || event.key === 'U')) {
                event.preventDefault();
            }
        });

        // Config
        const TARGET_DATE = new Date('2026-02-05T00:00:00');
        const urlParams = new URLSearchParams(window.location.search);
        const isTestMode = urlParams.get('test') === 'true';
        const bgParam = urlParams.get('bg'); // å¯ç”¨ URL è¨­å®šæ…¶ç”ŸèƒŒæ™¯ï¼Œå¦‚ ?bg=your.jpg

        // Elements
        const quizPhase = document.getElementById('quiz-phase');
        const analysisPhase = document.getElementById('analysis-phase');
        const resultPhase = document.getElementById('result-phase');
        const revealPhase = document.getElementById('reveal-phase');
        
        const btnSubmitQuiz = document.getElementById('btn-submit-quiz');
        const progressBar = document.getElementById('progress-bar');
        const analysisStatus = document.getElementById('analysis-status');
        const analysisCountdown = document.getElementById('analysis-countdown');
        const btnCalendar = document.getElementById('btn-calendar');
        
        const btnRevealDetails = document.getElementById('btn-reveal-details');
        const envelopeContainer = document.getElementById('envelope-container');
        const envelopeSvg = document.getElementById('envelope-svg');
        const messageContainer = document.getElementById('message-container');
        const messageArea = document.getElementById('message-area');
        const extrasContainer = document.getElementById('extras-container');
        const triviaText = document.getElementById('trivia-text');
        const btnSave = document.getElementById('btn-save');
        const logPhase = document.getElementById('log-phase');
        const logArea = document.getElementById('log-area');
        const analysisMetrics = document.getElementById('analysis-metrics');
        const subjectIdEl = document.getElementById('subject-id');
        const resultMetricsEl = document.getElementById('result-metrics');

        // BGM Element
        const bgm = new Audio('bgm.mp3'); // è«‹å°‡éŸ³æ¨‚æª”æ¡ˆå‘½åç‚º bgm.mp3 ä¸¦æ”¾åœ¨åŒç›®éŒ„ä¸‹
        bgm.loop = true;
        bgm.volume = 0.5;

        // Sound Effects (Web Audio API)
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTypingSound() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            
            oscillator.type = 'sine'; // simple click
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.05);
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.05);
        }

        // Starfield
        function createStars() {
            const container = document.getElementById('stars-container');
            for (let i = 0; i < 50; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const size = Math.random() * 2 + 1;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.setProperty('--duration', `${Math.random() * 3 + 2}s`);
                star.style.setProperty('--delay', `${Math.random() * 5}s`);
                star.style.setProperty('--opacity', Math.random() * 0.7 + 0.3);
                container.appendChild(star);
            }
        }
        createStars();

        // Shooting Stars
        function createShootingStar() {
            const container = document.getElementById('stars-container');
            const star = document.createElement('div');
            star.classList.add('shooting-star');
            
            // Random start position
            star.style.top = `${Math.random() * 50}%`;
            star.style.left = `${Math.random() * 100}%`;
            
            // Random duration and delay
            star.style.animationDuration = `${Math.random() * 2 + 1}s`;
            
            container.appendChild(star);
            
            // Remove after animation
            setTimeout(() => {
                star.remove();
            }, 4000);
        }
        
        // Spawn shooting stars periodically
        setInterval(createShootingStar, 3000);

        // Logic Entry Point
        function init() {
            const now = new Date();
            const quizCompleted = localStorage.getItem('quiz_completed') === 'true';
            
            // Apply optional birthday background to reveal phase
            applyRevealBackground();
            
            subjectIdEl.textContent = `å—è©¦è€…ç·¨è™Ÿï¼šBIDX-${Date.now().toString().slice(-6)}`;
            setupQuizEnhancements();

            // Check if we should skip to result (Test mode or Past Date)
            if (isTestMode || now >= TARGET_DATE) {
                showResultPhase();
            } else if (quizCompleted) {
                // If quiz done but still waiting
                showAnalysisPhase();
            } else {
                // Start with Quiz
                quizPhase.classList.remove('hidden');
                quizPhase.classList.add('fade-in');
            }
        }

        // Quiz Logic
        btnSubmitQuiz.addEventListener('click', () => {
            // Validate (optional, but good UX)
            const q1 = document.querySelector('input[name="q1"]:checked');
            const q2 = document.querySelector('input[name="q2"]:checked');
            const q3 = document.querySelector('input[name="q3"]:checked');

            if (!q1 || !q2 || !q3) {
                alert("è«‹å®Œæˆæ‰€æœ‰é¡Œç›®ä»¥é€²è¡Œç²¾ç¢ºåˆ†æã€‚");
                return;
            }

            localStorage.setItem('quiz_completed', 'true');
            
            // Transition to Analysis
            quizPhase.classList.add('fade-out');
            setTimeout(() => {
                quizPhase.classList.add('hidden');
                showLogPhase();
            }, 1500);
            
            const answers = {
                q1: q1.value,
                q2: q2.value,
                q3: q3.value
            };
            const t = (Date.now() - quizStart) / 1000;
            const totalChanges = changeCounts.q1 + changeCounts.q2 + changeCounts.q3;
            const social = answers.q2 === 'A' ? 0.8 : answers.q2 === 'B' ? 0.5 : 0.2;
            const solitude = answers.q3 === 'A' ? 0.1 : answers.q3 === 'B' ? 0.4 : 0.8;
            const festival = answers.q1 === 'A' ? 'äººç¾¤åå¥½' : answers.q1 === 'B' ? 'ç†Ÿå‹åå¥½' : 'éœæ…‹åå¥½';
            let credibility = 0.8;
            credibility += t > 10 ? 0.05 : -0.15;
            credibility += totalChanges >= 2 ? 0.05 : -0.05;
            credibility = Math.max(0.6, Math.min(0.95, credibility));
            const checksum = makeChecksum(JSON.stringify({ answers, t, totalChanges, subject: subjectIdEl.textContent }));
            const summary = {
                social,
                solitude,
                festival,
                credibility,
                checksum
            };
            localStorage.setItem('survey_data', JSON.stringify(summary));
        });
        
        let quizStart = Date.now();
        const changeCounts = { q1: 0, q2: 0, q3: 0 };
        
        function setupQuizEnhancements() {
            shuffleOptions('q1');
            shuffleOptions('q2');
            shuffleOptions('q3');
            document.querySelectorAll('input[name="q1"]').forEach(el => el.addEventListener('change', () => changeCounts.q1++));
            document.querySelectorAll('input[name="q2"]').forEach(el => el.addEventListener('change', () => changeCounts.q2++));
            document.querySelectorAll('input[name="q3"]').forEach(el => el.addEventListener('change', () => changeCounts.q3++));
            quizStart = Date.now();
        }
        
        function shuffleOptions(name) {
            const labels = Array.from(document.querySelectorAll(`input[name="${name}"]`)).map(i => i.parentElement);
            const parent = labels[0]?.parentElement;
            if (!parent) return;
            const shuffled = labels.sort(() => Math.random() - 0.5);
            shuffled.forEach(l => parent.appendChild(l));
        }

        function showLogPhase() {
            logPhase.classList.remove('hidden');
            logPhase.classList.add('fade-in');
            logArea.textContent = '';
            let i = 0;
            const lines = [
                '> é€£ç·šè³‡æ–™æ¹–ç¯€é»â€¦å®Œæˆ',
                '> æå–åˆ†ç‰‡ shard-17 â€¦å®Œæˆ',
                '> æå–åˆ†ç‰‡ shard-23 â€¦å®Œæˆ',
                '> å»ºç«‹è‡¨æ™‚ç´¢å¼•â€¦å®Œæˆ',
                '> é€²è¡Œç‰¹å¾µå“ˆå¸Œâ€¦å®Œæˆ',
                '> åˆä½µå‘é‡ç°‡â€¦å®Œæˆ',
                '> ç†µå€¼æ¡æ¨£â€¦å®Œæˆ',
                '> ç”Ÿæˆé›¶çŸ¥è­˜æ‘˜è¦â€¦å®Œæˆ',
                '> æœ€çµ‚åŠ å¯†å°åŒ…â€¦å®Œæˆ'
            ];
            const timer = setInterval(() => {
                const t = new Date().toLocaleTimeString();
                const s = lines[i % lines.length];
                logArea.textContent += `[${t}] ${s}\n`;
                logArea.scrollTop = logArea.scrollHeight;
                i++;
            }, 120);
            setTimeout(() => {
                clearInterval(timer);
                logPhase.classList.add('fade-out');
                setTimeout(() => {
                    logPhase.classList.add('hidden');
                    showAnalysisPhase();
                }, 800);
            }, 3000);
        }

        // Analysis Phase Logic
        function showAnalysisPhase() {
            analysisPhase.classList.remove('hidden');
            
            // Animate Progress Bar to 99.9%
            setTimeout(() => {
                progressBar.style.width = '99.9%';
                progressBar.classList.add('pulse-bar');
            }, 100);

            // Start Countdown
            const updateTimer = () => {
                const now = new Date();
                
                // If time reached while on this screen
                if (now >= TARGET_DATE) {
                    progressBar.style.width = '100%';
                    analysisStatus.textContent = "> ç‹€æ…‹ï¼šåˆ†æå®Œæˆã€‚";
                    analysisCountdown.textContent = "> æº–å‚™è§£é–å ±å‘Š...";
                    
                    setTimeout(() => {
                        analysisPhase.classList.add('fade-out');
                        setTimeout(() => {
                            analysisPhase.classList.add('hidden');
                            showResultPhase();
                        }, 1500);
                    }, 2000);
                    return;
                }

                const diff = TARGET_DATE - now;
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                analysisCountdown.textContent = `> é è¨ˆåˆ†æå®Œæˆå‰©é¤˜æ™‚é–“ï¼š${days}å¤© ${hours}æ™‚ ${minutes}åˆ† ${seconds}ç§’`;
                requestAnimationFrame(updateTimer);
            };
            updateTimer();

            // Show Calendar Button after a short delay
            setTimeout(() => {
                btnCalendar.classList.remove('hidden');
                btnCalendar.classList.add('fade-in');
            }, 4000);
            
            let e = 0.62;
            const entropyTimer = setInterval(() => {
                const delta = (Math.random() - 0.5) * 0.08;
                e = Math.max(0.01, Math.min(0.99, e + delta));
                const n = (Math.random() * 0.2 + 0.1).toFixed(2);
                analysisMetrics.textContent = `> ç’°å¢ƒç†µå€¼ï¼š${e.toFixed(2)} | å™ªè²æ¯”ï¼š${n}`;
                if (analysisStatus.textContent.includes('åˆ†æå®Œæˆ')) {
                    clearInterval(entropyTimer);
                }
            }, 500);
        }

        // Optional Background for Reveal Phase
        function applyRevealBackground() {
            const img = bgParam ? bgParam : 'è¢å¹•æ“·å–ç•«é¢ 2026-02-04 102652.png';
            const fallback = 'birthday-bg.jpg';
            if (img) {
                revealPhase.style.backgroundImage = `url('${img}')`;
                revealPhase.classList.add('has-bg');
            }
            // Optional fallback if desired imageæœªå‘½ä¸­ï¼ˆä¿ç•™åŸæœ¬é è¨­æª”åï¼‰
            if (!revealPhase.style.backgroundImage) {
                revealPhase.style.backgroundImage = `url('${fallback}')`;
                revealPhase.classList.add('has-bg');
            }
        }

        // Calendar Logic
        btnCalendar.addEventListener('click', () => {
            const icsContent = 
`BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Birthday Surprise//B-Index//EN
BEGIN:VEVENT
UID:uid1@example.com
DTSTAMP:20240101T000000Z
DTSTART:20260204T160000Z
DTEND:20260204T170000Z
SUMMARY:é‚Šç·£äººé‘‘å®šå ±å‘Šè§£é–
DESCRIPTION:è«‹å›åˆ°ç¶²é æŸ¥çœ‹æ‚¨çš„åˆ†æçµæœã€‚
END:VEVENT
END:VCALENDAR`;
            // Note: DTSTART is UTC. 2026-02-05 00:00 Taiwan is 2026-02-04 16:00 UTC.
            
            const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(blob);
            link.setAttribute('download', 'surprise_unlock.ics');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Result Phase Logic
        function showResultPhase() {
            resultPhase.classList.remove('hidden');
            resultPhase.classList.add('fade-in');
            const raw = localStorage.getItem('survey_data');
            if (raw) {
                const s = JSON.parse(raw);
                const cred = Math.round(s.credibility * 100);
                resultMetricsEl.textContent = `å¯ä¿¡åº¦ï¼š${cred}% | æ¨¡å‹ v0.9.3 | æ ¡é©—ç¢¼ï¼š${s.checksum}`;
            } else {
                const cred = Math.round((0.8 + Math.random() * 0.1) * 100);
                resultMetricsEl.textContent = `å¯ä¿¡åº¦ï¼š${cred}% | æ¨¡å‹ v0.9.3 | æ ¡é©—ç¢¼ï¼š${makeChecksum(String(Date.now()))}`;
            }
        }

        btnRevealDetails.addEventListener('click', () => {
            // Try to play BGM
            bgm.play().catch(e => console.log("BGM not found or blocked: ", e));

            resultPhase.classList.add('fade-out');
            setTimeout(() => {
                resultPhase.classList.add('hidden');
                revealPhase.classList.remove('hidden');
                // Envelope is visible by default in revealPhase structure
            }, 1500);
        });

        // Envelope Click Logic
        envelopeSvg.addEventListener('click', () => {
            envelopeContainer.classList.add('fade-out');
            setTimeout(() => {
                envelopeContainer.classList.add('hidden');
                messageContainer.classList.remove('hidden');
                messageContainer.classList.add('fade-in');
                typeWriter();
            }, 1000);
        });

        function typeWriter() {
            const text = "è‡ª 2024 åŒ†åŒ†ä¸€ç¥åˆ°ç¾åœ¨ä¹Ÿå¥½ä¹…äº†ï¼Œ\nç¥ä½ ç”Ÿæ—¥å¿«æ¨‚å‘€ã€‚";
            let i = 0;
            const speed = 100;
            
            function type() {
                if (i < text.length) {
                    messageArea.textContent += text.charAt(i);
                    // Play sound for non-space characters
                    if (text.charAt(i).trim() !== '') {
                        playTypingSound();
                    }
                    i++;
                    setTimeout(type, speed);
                } else {
                    // Typewriter finished
                    setTimeout(() => {
                        extrasContainer.classList.remove('hidden');
                    }, 500);
                }
            }
            type();
        }
        
        function makeChecksum(s) {
            let h = 0;
            for (let i = 0; i < s.length; i++) {
                h = (h << 5) - h + s.charCodeAt(i);
                h |= 0;
            }
            return (h >>> 0).toString(16).padStart(8, '0');
        }

        // Extras Logic
        let triviaClicked = false;
        triviaText.addEventListener('click', () => {
            if (!triviaClicked) {
                triviaText.classList.add('fade-out');
                setTimeout(() => {
                    triviaText.classList.remove('fade-out');
                    triviaText.classList.add('fade-in');
                    triviaText.innerHTML = "å› ç‚ºè¢«å‚¬ä¿ƒæ™‚æœƒèªªï¼šæˆ‘å¾ˆå¿«äº†ï¼ˆæˆ‘å¾ˆå¿«æ¨‚ï¼‰ã€‚<br>å“ˆå“ˆä¸å¥½ç¬‘ï¼Œç¥ä½ æœ‰å¿«æ¨‚çš„ä¸€å¤©ã€‚";
                    triviaText.style.textDecoration = 'none';
                    triviaText.style.cursor = 'default';
                }, 1500);
                triviaClicked = true;
            }
        });

        btnSave.addEventListener('click', () => {
            const captureElement = document.getElementById('capture-area');
            html2canvas(captureElement, {
                backgroundColor: "#000000",
                scale: 2
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'birthday-wish.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        });

        // Initialize
        init();

    </script>
</body>
</html>
